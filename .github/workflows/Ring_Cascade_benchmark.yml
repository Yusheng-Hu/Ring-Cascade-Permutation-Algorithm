name: Ring-Cascade-Permutation-Algorithm Benchmark

on:
  #push:
  #  branches: [ "main" ]
  #  paths:
      # Only trigger if this specific file changes
  #    - 'Ring-Cascade-Permutation-Algorithm.cpp'
  workflow_dispatch:

jobs:
  benchmark:
    name: Run Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get CPU Info
        # Get hardware model for environment context
        run: |
          MODEL=$(lscpu | grep "Model name" | cut -d':' -f2 | xargs)
          echo "CPU_MODEL=$MODEL" >> $GITHUB_ENV

      - name: Compile
        # Compile with maximum optimization flags
        run: |
          g++ -O3 -std=c++11 -march=native -flto -ffast-math -fomit-frame-pointer \
          Ring-Cascade-Permutation-Algorithm.cpp -o Ring_Cascade_test -pthread

      - name: Execute and Parse
        # Run the binary and dynamically extract N, Time, and Checksum
        run: |
          ./Ring_Cascade_test | tee run_log.txt
          
          # Dynamic extraction from runtime output
          DYNAMIC_N=$(grep "PARAM_N" run_log.txt | awk '{print $2}' | tr -d '\r\n')
          TIME_VAL=$(grep "RESULT_TIME" run_log.txt | awk '{print $2}' | tr -d '\r\n')
          CHECK_VAL=$(grep "CHECKSUM_COUNT" run_log.txt | awk '{print $2}' | tr -d '\r\n')
          
          # Save to environment variables
          echo "REPORT_N=$DYNAMIC_N" >> $GITHUB_ENV
          echo "TIME_Ring_Cascade=$TIME_VAL" >> $GITHUB_ENV
          echo "CHECKSUM=$CHECK_VAL" >> $GITHUB_ENV

      - name: Generate Summary Report
        # Create a professional Markdown summary using the dynamic variables
        if: always()
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ### ðŸš€ Performance Benchmark Report (N=${{ env.REPORT_N }})

          | Metric | Value |
          | :--- | :--- |
          | **Input Size (N)** | ${{ env.REPORT_N }} |
          | **Execution Time** | \`${{ env.TIME_Ring_Cascade }} s\` |
          | **Total Permutations** | \`${{ env.CHECKSUM }}\` |
          | **Status** | âœ… Completed |

          #### ðŸ’» System Environment
          - **Processor:** ${{ env.CPU_MODEL }}
          - **Optimization:** \`-O3 -march=native -flto\`
          - **Generated At:** $(date -u)
          EOF
