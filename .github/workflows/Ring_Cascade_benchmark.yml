name: RCPA-vs-Heap-Comparison-Benchmark

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # --- Stage 1: Benchmark Execution ---
  benchmark:
    name: Comparison (N=${{ matrix.n_factor }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        n_factor: [10, 11, 12, 13]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Detect CPU Architecture
      run: |
        CPU_NAME=$(lscpu | grep 'Model name' | cut -f 2 -d ":" | sed 's/^[ \t]*//')
        if [[ "$CPU_NAME" == *"AMD"* ]]; then VENDOR="AMD"; else VENDOR="INTEL"; fi
        echo "CPU_MODEL=$CPU_NAME" >> $GITHUB_ENV
        echo "VENDOR=$VENDOR" >> $GITHUB_ENV

    - name: Compile Source Files
      run: |
        # Ensure path points to 'cpp/' directory
        g++ -O3 -std=c++11 -march=native -ffast-math \
        cpp/Ring_Cascade_Permutation_Algorithm.cpp -o rcpa_test -pthread
        
        g++ -O3 -march=native cpp/heap_perm.cpp -o heap_test -pthread

    - name: Run Performance Test
      run: |
        # Get Heap's Algorithm timing
        H_OUT=$(./heap_test ${{ matrix.n_factor }})
        H_TIME=$(echo "$H_OUT" | grep "EXECUTION_TIME:" | awk '{print $2}')
        
        # Get RCPA timing
        R_OUT=$(./rcpa_test ${{ matrix.n_factor }})
        R_TIME=$(echo "$R_OUT" | grep "EXECUTION_TIME:" | awk '{print $2}')
        
        # Calculate speedup factor
        SPEEDUP=$(echo "scale=2; $H_TIME / $R_TIME" | bc)
        
        echo "N=${{ matrix.n_factor }}|H=$H_TIME|R=$R_TIME|S=$SPEEDUP" > res_${{ matrix.n_factor }}.txt

    - name: Upload Result Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: raw-res-${{ matrix.n_factor }}-${{ env.VENDOR }}
        path: res_${{ matrix.n_factor }}.txt

  # --- Stage 2: README Update ---
  update-readme:
    name: Update README with Comparison Table
    needs: benchmark
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: results
        pattern: raw-res-*

    - name: Process Results
      shell: python
      run: |
        import os, glob, re
        
        vendor = os.environ.get('VENDOR', 'INTEL')
        start_m = f"[//]: # (RCPA_VS_HEAP_{vendor}_START)"
        end_m = f"[//]: # (RCPA_VS_HEAP_{vendor}_END)"
        
        # Updated Table Header (Removed Status)
        rows = [
            "| N | Heap's Algorithm (s) | RCPA (s) | Speedup (vs Heap) |",
            "|---|---|---|---|"
        ]
        
        res_files = glob.glob("results/raw-res-*/res_*.txt")
        data_points = []
        for f in res_files:
            with open(f, 'r') as file:
                match = re.search(r"N=(\d+)\|H=([\d.]+)\|R=([\d.]+)\|S=([\d.]+)", file.read().strip())
                if match: data_points.append(match.groups())
        
        # Sort by N and build rows
        for n, h, r, s in sorted(data_points, key=lambda x: int(x[0])):
            rows.append(f"| {n} | {h} s | {r} s | **{s}x** |")

        new_table = "\n".join(rows)
        
        with open("README.md", "r", encoding="utf-8") as f:
            content = f.read()
            
        if start_m in content and end_m in content:
            pattern = rf"{re.escape(start_m)}.*?{re.escape(end_m)}"
            updated = re.sub(pattern, f"{start_m}\n\n{new_table}\n\n{end_m}", content, flags=re.DOTALL)
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(updated)
        else:
            print(f"Error: Marker {start_m} not found!")
            exit(1)

    - name: Push to Main Branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        git commit -m "docs: remove status column from benchmark results [skip ci]" || exit 0
        git push origin mainname: RCPA-vs-Heap-Comparison-Benchmark

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # --- Stage 1: Benchmark Execution ---
  benchmark:
    name: Comparison (N=${{ matrix.n_factor }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        n_factor: [10, 11, 12]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Detect CPU Architecture
      run: |
        CPU_NAME=$(lscpu | grep 'Model name' | cut -f 2 -d ":" | sed 's/^[ \t]*//')
        if [[ "$CPU_NAME" == *"AMD"* ]]; then VENDOR="AMD"; else VENDOR="INTEL"; fi
        echo "CPU_MODEL=$CPU_NAME" >> $GITHUB_ENV
        echo "VENDOR=$VENDOR" >> $GITHUB_ENV

    - name: Compile Source Files
      run: |
        # Ensure path points to 'cpp/' directory
        g++ -O3 -std=c++11 -march=native -ffast-math \
        cpp/Ring_Cascade_Permutation_Algorithm.cpp -o rcpa_test -pthread
        
        g++ -O3 -march=native cpp/heap_perm.cpp -o heap_test -pthread

    - name: Run Performance Test
      run: |
        # Get Heap's Algorithm timing
        H_OUT=$(./heap_test ${{ matrix.n_factor }})
        H_TIME=$(echo "$H_OUT" | grep "EXECUTION_TIME:" | awk '{print $2}')
        
        # Get RCPA timing (ensure code uses REPORT_START)
        R_OUT=$(./rcpa_test ${{ matrix.n_factor }})
        R_TIME=$(echo "$R_OUT" | grep "EXECUTION_TIME:" | awk '{print $2}')
        
        # Calculate speedup factor
        SPEEDUP=$(echo "scale=2; $H_TIME / $R_TIME" | bc)
        
        echo "N=${{ matrix.n_factor }}|H=$H_TIME|R=$R_TIME|S=$SPEEDUP" > res_${{ matrix.n_factor }}.txt

    - name: Upload Result Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: raw-res-${{ matrix.n_factor }}-${{ env.VENDOR }}
        path: res_${{ matrix.n_factor }}.txt

  # --- Stage 2: README Update ---
  update-readme:
    name: Update README with Comparison Table
    needs: benchmark
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: results
        pattern: raw-res-*

    - name: Process Results
      shell: python
      run: |
        import os, glob, re
        
        # Use VENDOR from the environment
        vendor = os.environ.get('VENDOR', 'INTEL')
        start_m = f"[//]: # (RCPA_VS_HEAP_{vendor}_START)"
        end_m = f"[//]: # (RCPA_VS_HEAP_{vendor}_END)"
        
        # Table Header
        rows = [
            "| N | Heap's Algorithm (s) | RCPA (s) | Speedup (vs Heap) | Status |",
            "|---|---|---|---|---|"
        ]
        
        res_files = glob.glob("results/raw-res-*/res_*.txt")
        data_points = []
        for f in res_files:
            with open(f, 'r') as file:
                match = re.match(r"N=(\d+)\|H=([\d.]+)\|R=([\d.]+)\|S=([\d.]+)", file.read().strip())
                if match: data_points.append(match.groups())
        
        # Sort by N and build rows
        for n, h, r, s in sorted(data_points, key=lambda x: int(x[0])):
            rows.append(f"| {n} | {h} s | {r} s | **{s}x** | âœ… |")

        new_table = "\n".join(rows)
        
        with open("README.md", "r", encoding="utf-8") as f:
            content = f.read()
            
        if start_m in content and end_m in content:
            pattern = rf"{re.escape(start_m)}.*?{re.escape(end_m)}"
            # Preserve markers during replacement
            updated = re.sub(pattern, f"{start_m}\n\n{new_table}\n\n{end_m}", content, flags=re.DOTALL)
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(updated)
        else:
            print(f"Error: Marker {start_m} not found!")
            exit(1)

    - name: Push to Main Branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        git commit -m "docs: update rcpa vs heap benchmark results [skip ci]" || exit 0
        git push origin main
