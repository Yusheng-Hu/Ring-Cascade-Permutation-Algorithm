name: RCPA-vs-Heap-Comparison-Benchmark

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Sequential job ensures all N factors run on the SAME hardware instance
  benchmark-and-update:
    name: Sequential Benchmark & README Update
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Detect CPU Architecture
      id: cpu_info
      run: |
        # Identify CPU model and set vendor tag for sectioning
        MODEL_NAME=$(grep -m 1 "model name" /proc/cpuinfo | cut -d: -f2 | xargs)
        if [[ "$MODEL_NAME" == *"AMD"* ]]; then VENDOR="AMD"; else VENDOR="INTEL"; fi
        echo "vendor_tag=$VENDOR" >> $GITHUB_OUTPUT
        echo "CPU_MODEL=$MODEL_NAME" >> $GITHUB_ENV

    - name: Compile C++ Sources
      run: |
        # Compile both algorithms located in the cpp/ directory
        g++ -O3 -std=c++11 -march=native -ffast-math cpp/Ring_Cascade_Permutation_Algorithm.cpp -o rcpa_test -pthread
        g++ -O3 -march=native cpp/heap_perm.cpp -o heap_test -pthread

    - name: Execute Sequential Benchmark
      run: |
        # Use a bash loop to run all N factors on this specific CPU instance
        N_FACTORS=(10 11 12 13)
        echo "Starting benchmarks sequentially..."
        
        for n in "${N_FACTORS[@]}"; do
          echo "Running N=$n..."
          
          # Run Heap's Algorithm
          H_OUT=$(./heap_test $n)
          H_TIME=$(echo "$H_OUT" | grep "EXECUTION_TIME:" | awk '{print $2}')
          
          # Run Ring Cascade Permutation Algorithm (RCPA)
          R_OUT=$(./rcpa_test $n)
          R_TIME=$(echo "$R_OUT" | grep "EXECUTION_TIME:" | awk '{print $2}')
          
          # Calculate Speedup (Heap / RCPA)
          SPEEDUP=$(echo "scale=2; $H_TIME / $R_TIME" | bc)
          
          # Save result to a shared local file
          echo "N=$n|H=$H_TIME|R=$R_TIME|S=$SPEEDUP" >> results_all.txt
        done

    - name: Update README.md
      shell: python
      run: |
        import os, re
        from datetime import datetime, timezone, timedelta

        # 1. Configuration
        vendor = "${{ steps.cpu_info.outputs.vendor_tag }}"
        cpu_str = "${{ env.CPU_MODEL }}"
        
        # 2. Match standard Heap vs RCPA markers
        start_tag = f"[//]: # (RCPA_PERFORMANCE_{vendor}_START)"
        end_tag = f"[//]: # (RCPA_PERFORMANCE_{vendor}_END)"
        
        # 3. Time Headers
        now_utc = datetime.now(timezone.utc)
        now_bj = now_utc + timedelta(hours=8)
        ts_header = f"**Last Run:** {now_utc.strftime('%Y-%m-%d %H:%M:%S UTC')} / {now_bj.strftime('%Y-%m-%d %H:%M:%S (UTC+8)')}"
        
        # 4. Table Construction
        table = [
            ts_header,
            f"**Processor:** `{cpu_str}`",
            "",
            "| N | Heap's Algorithm (s) | RCPA (s) | Speedup (vs Heap) |",
            "| :--- | :--- | :--- | :--- |"
        ]
        
        # 5. Extract data from the local sequential file
        data_points = []
        if os.path.exists("results_all.txt"):
            with open("results_all.txt", "r") as f:
                for line in f:
                    m = re.search(r"N=(\d+)\|H=([\d.]+)\|R=([\d.]+)\|S=([\d.]+)", line)
                    if m:
                        data_points.append(m.groups())

        # 6. Sort and build rows
        for n, h, r, s in sorted(data_points, key=lambda x: int(x[0])):
            table.append(f"| {n} | {h} s | {r} s | **{s}x** |")

        final_content = "\n".join(table)
        
        # 7. Safe Injection into README
        with open("README.md", "r", encoding="utf-8") as f:
            readme = f.read()
            
        pattern = re.escape(start_tag) + r".*?" + re.escape(end_tag)
        if re.search(pattern, readme, re.DOTALL):
            updated_readme = re.sub(pattern, f"{start_tag}\n\n{final_content}\n\n{end_tag}", readme, flags=re.DOTALL)
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(updated_readme)
        else:
            print(f"Error: Markers {start_tag} not found.")
            exit(1)

    - name: Commit and Push Updates
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        git commit -m "docs: update Heap vs RCPA benchmark results [skip ci]" || exit 0
        git push origin main
