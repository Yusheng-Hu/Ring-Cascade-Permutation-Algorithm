name: RCPA-vs-Heap-Comparison-Benchmark

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  benchmark:
    name: Comparison (N=${{ matrix.n_factor }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        n_factor: [10, 11, 12, 13]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Detect and Log Raw CPU Info
      run: |
        # 1. Capture absolute raw data
        RAW_LSCPU_FULL=$(lscpu)
        RAW_PROC_CPU=$(head -n 25 /proc/cpuinfo)
        
        # 2. Basic Vendor check for marker selection
        if echo "$RAW_LSCPU_FULL" | grep -qi "AMD"; then VENDOR="AMD"; else VENDOR="INTEL"; fi
        
        # 3. Export raw data to files for Stage 2 (escaping newlines)
        echo "$RAW_LSCPU_FULL" > raw_lscpu.log
        echo "$RAW_PROC_CPU" > raw_proc.log
        echo "VENDOR=$VENDOR" >> $GITHUB_ENV

    - name: Compile and Run
      run: |
        g++ -O3 -std=c++11 -march=native -ffast-math cpp/Ring_Cascade_Permutation_Algorithm.cpp -o rcpa_test -pthread
        g++ -O3 -march=native cpp/heap_perm.cpp -o heap_test -pthread
        
        H_TIME=$(./heap_test ${{ matrix.n_factor }} | grep "EXECUTION_TIME:" | awk '{print $2}')
        R_TIME=$(./rcpa_test ${{ matrix.n_factor }} | grep "EXECUTION_TIME:" | awk '{print $2}')
        SPEEDUP=$(echo "scale=2; $H_TIME / $R_TIME" | bc)
        echo "N=${{ matrix.n_factor }}|H=$H_TIME|R=$R_TIME|S=$SPEEDUP" > res_${{ matrix.n_factor }}.txt

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debug-data-${{ matrix.n_factor }}
        path: |
          res_*.txt
          raw_*.log

  update-readme:
    needs: benchmark
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: debug_results
        pattern: debug-data-*

    - name: Inject Raw Hardware Info into README
      shell: python
      run: |
        import os, glob, re
        from datetime import datetime, timedelta

        vendor = os.environ.get('VENDOR', 'INTEL')
        start_m = f"[//]: # (RCPA_VS_HEAP_{vendor}_START)"
        end_m = f"[//]: # (RCPA_VS_HEAP_{vendor}_END)"
        
        # Load Raw Data from first artifact
        log_dir = glob.glob("debug_results/debug-data-*")[0]
        with open(os.path.join(log_dir, "raw_lscpu.log"), "r") as f:
            raw_lscpu = f.read()
        with open(os.path.join(log_dir, "raw_proc.log"), "r") as f:
            raw_proc = f.read()

        now_bj = datetime.utcnow() + timedelta(hours=8)
        ts = f"**Last Run:** {datetime.utcnow().strftime('%a %b %d %H:%M:%S %Y UTC')} / {now_bj.strftime('%a %b %d %H:%M:%S %Y (UTC+8)')}"

        # Build the "Detective" Report
        report = [
            ts,
            "### üîç Raw Hardware Probe (Debug)",
            "#### [lscpu output]",
            "```text", raw_lscpu, "```",
            "#### [/proc/cpuinfo excerpt]",
            "```text", raw_proc, "```",
            "",
            "| N | Heap's Algorithm (s) | RCPA (s) | Speedup |",
            "|---|---|---|---|"
        ]

        # Gather results
        data = []
        for f in glob.glob("debug_results/debug-data-*/res_*.txt"):
            m = re.search(r"N=(\d+)\|H=([\d.]+)\|R=([\d.]+)\|S=([\d.]+)", open(f).read())
            if m: data.append(m.groups())
        
        for n, h, r, s in sorted(data, key=lambda x: int(x[0])):
            report.append(f"| {n} | {h} s | {r} s | **{s}x** |")

        new_content = "\n".join(report)
        
        with open("README.md", "r", encoding="utf-8") as f:
            readme = f.read()
        
        if start_m in readme and end_m in readme:
            pattern = rf"{re.escape(start_m)}.*?{re.escape(end_m)}"
            # Force inclusion of all raw text between markers
            updated = re.sub(pattern, f"{start_m}\n\n{new_content}\n\n{end_m}", readme, flags=re.DOTALL)
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(updated)

    - name: Push to GitHub
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        git commit -m "debug: dump raw cpu info to readme [skip ci]" || exit 0
        git push origin main
