name: RCPA-Performance-Benchmark

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  benchmark:
    name: RCPA Sequential Benchmark
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect CPU Info
      run: |
        CPU_NAME=$(lscpu | grep 'Model name' | cut -f 2 -d ":" | sed 's/^[ \t]*//')
        if [[ "$CPU_NAME" == *"AMD"* ]]; then VENDOR="AMD"; else VENDOR="INTEL"; fi
        echo "CPU_MODEL=$CPU_NAME" >> $GITHUB_ENV
        echo "VENDOR=$VENDOR" >> $GITHUB_ENV

    - name: Compile RCPA
      run: |
        g++ -O3 -std=c++11 -march=native -ffast-math -fomit-frame-pointer \
        cpp/Ring_Cascade_Permutation_Algorithm.cpp -o rcpa_bin -pthread

    - name: Run Sequential Benchmarks and Update README
      shell: python
      run: |
        import os, subprocess, re

        # 1. Configuration
        n_factors = [10, 11, 12, 13]
        vendor = os.environ.get('VENDOR', 'INTEL')
        cpu_model = os.environ.get('CPU_MODEL', 'Unknown')
        start_m = f"[//]: # (RCPA_PERFORMANCE_{vendor}_START)"
        end_m = f"[//]: # (RCPA_PERFORMANCE_{vendor}_END)"
        readme_path = "README.md"

        # 2. Load and Locate Area
        with open(readme_path, "r", encoding="utf-8") as f:
            readme_content = f.read()

        if start_m not in readme_content or end_m not in readme_content:
            print(f"Error: Markers not found")
            exit(1)

        parts = readme_content.split(start_m)
        prefix = parts[0]
        middle_suffix = parts[1].split(end_m)
        content_area = middle_suffix[0].strip()
        suffix = middle_suffix[1]

        # 3. Define Table Template if empty
        if "| Algorithm |" not in content_area:
            content_area = "| Algorithm | N | Time | CPU | Status |\n| :--- | :--- | :--- | :--- | :--- |"

        # 4. Process each N factor
        # We split current table into lines to manage them properly
        table_lines = content_area.split('\n')

        for n in n_factors:
            print(f"Running N={n}...")
            result = subprocess.run(["./rcpa_bin", str(n)], capture_output=True, text=True)
            match = re.search(r"\[METRIC_START\]\nN_VALUE: (\d+)\nTIME_SEC: ([\d.]+)\n\[METRIC_END\]", result.stdout)
            
            if match:
                n_val, time_sec = match.group(1), match.group(2)
                # Correct column mapping: Algorithm | N | Time | CPU | Status
                new_row = f"| **RCPA** | **{n_val}** | {time_sec} s | `{cpu_model}` | âœ… |"
                
                # Update logic: check if row with this N exists
                row_pattern = rf"\| \*\*RCPA\*\* \| \*\*{n_val}\*\* \|"
                found = False
                for i, line in enumerate(table_lines):
                    if re.search(row_pattern, line):
                        table_lines[i] = new_row
                        found = True
                        break
                if not found:
                    table_lines.append(new_row)

        # 5. Clean up table structure and reassemble
        # Ensure there are NO empty lines inside the table but double newlines around markers
        final_table = "\n".join([line for line in table_lines if line.strip()])
        new_readme = f"{prefix}{start_m}\n\n{final_table}\n\n{end_m}{suffix}"

        with open(readme_path, "w", encoding="utf-8") as f:
            f.write(new_readme)

    - name: Synchronized Push
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        if git commit -m "docs: fix RCPA table columns and marker visibility [skip ci]"; then
          git push origin main
        else
          echo "No changes to commit"
        fi
