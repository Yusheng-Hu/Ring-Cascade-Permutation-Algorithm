name: ppa and rcpa complex Benchmark

on:
  push:
    branches: [ "main" ]
    # Line 6: Now correctly indented under 'push'
    paths:
      - 'cpp/ppa_rcpa.cpp'
      
  pull_request:
    branches: [ "main" ]
    # Also correctly indented under 'pull_request'
    paths:
      - 'cpp/ppa_rcpa.cpp'

jobs:
  performance-test:
    name: High-Performance Algorithmic Benchmark
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Detect CPU Info
      run: |
        CPU_NAME=$(lscpu | grep 'Model name' | cut -f 2 -d ":" | sed 's/^[ \t]*//')
        echo "CPU_MODEL=$CPU_NAME" >> $GITHUB_ENV

    - name: Setup Build Environment
      run: sudo apt-get update && sudo apt-get install -y build-essential

    - name: Compile with Extreme Optimization
      run: |
        g++ -O3 -std=c++11 -march=native -flto -ffast-math -fomit-frame-pointer \
        cpp/ppa_rcpa.cpp -o benchmark_bin -pthread

    - name: Execute Benchmark
      id: run_bench
      run: |
        ./benchmark_bin > result.txt
        cat result.txt
        
        # Standardized Data Extraction
        REAL_N=$(grep "^N:" result.txt | awk '{print $2}')
        PERMS=$(grep "Total Permutations:" result.txt | awk '{print $3}')
        TIME=$(grep "Time:" result.txt | awk '{print $2}')
        SPEED=$(grep "Speed:" result.txt | awk '{print $2}')
        
        echo "REAL_N=$REAL_N" >> $GITHUB_ENV
        echo "PERMS=$PERMS" >> $GITHUB_ENV
        echo "TIME=$TIME" >> $GITHUB_ENV
        echo "SPEED=$SPEED" >> $GITHUB_ENV

    - name: Publish Performance Report
      if: always()
      run: |
        echo "### ðŸš€ High-Throughput Performance Report (N=${{ env.REAL_N }})" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Result |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Processor** | ${{ env.CPU_MODEL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Algorithm** | PP + Circle Hybrid |" >> $GITHUB_STEP_SUMMARY
        echo "| **N-Factor** | **${{ env.REAL_N }}** |" >> $GITHUB_STEP_SUMMARY
        echo "| **Total Permutations** | ${{ env.PERMS }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Execution Time** | ${{ env.TIME }} s |" >> $GITHUB_STEP_SUMMARY
        echo "| **Throughput Speed** | ðŸ”¥ **${{ env.SPEED }} Giga-perms/sec** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "> **Note**: Data verified via automated log extraction from standard C++ output." >> $GITHUB_STEP_SUMMARY

    - name: Upload Binary Artifact
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-linux-bin
        path: benchmark_bin
