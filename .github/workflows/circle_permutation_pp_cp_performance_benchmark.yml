name: Circle-PP-CP-Performance-Benchmark

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  performance-test:
    name: Ubuntu Linux Performance (N=14)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Detect CPU Info
      run: |
        CPU_NAME=$(lscpu | grep 'Model name' | cut -f 2 -d ":" | sed 's/^[ \t]*//')
        echo "CPU_MODEL=$CPU_NAME" >> $GITHUB_ENV

    - name: Setup Build Environment
      run: sudo apt-get update && sudo apt-get install -y build-essential

    - name: Compile with Extreme Optimization
      run: |
        # Ensure the path cpp/pure_circle.cpp is correct in your repo
        g++ -O3 -std=c++11 -march=native -flto -ffast-math -fomit-frame-pointer \
        cpp/pure_circle.cpp -o benchmark_bin -pthread

    - name: Execute Benchmark
      id: run_bench
      run: |
        echo "Running benchmark on ${{ env.CPU_MODEL }}..."
        ./benchmark_bin > result.txt
        cat result.txt
        
        # Data Extraction
        PERMS=$(grep "Total Permutations:" result.txt | awk '{print $3}')
        TIME=$(grep "Time:" result.txt | awk '{print $2}')
        SPEED=$(grep "Speed:" result.txt | awk '{print $2}')
        
        echo "PERMS=$PERMS" >> $GITHUB_ENV
        echo "TIME=$TIME" >> $GITHUB_ENV
        echo "SPEED=$SPEED" >> $GITHUB_ENV

    - name: Publish Performance Report
      if: always()
      run: |
        echo "### ðŸš€ High-Throughput Performance Report" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Result |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| **CPU Processor** | ${{ env.CPU_MODEL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Algorithm** | PP + Circle Hybrid |" >> $GITHUB_STEP_SUMMARY
        echo "| **N Factor** | 14 |" >> $GITHUB_STEP_SUMMARY
        echo "| **Permutations Count** | ${{ env.PERMS }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Execution Time** | ${{ env.TIME }} s |" >> $GITHUB_STEP_SUMMARY
        echo "| **Throughput** | ðŸ”¥ **${{ env.SPEED }} Giga-perms/sec** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> *Compiler Flags: -O3 -march=native -flto -ffast-math*" >> $GITHUB_STEP_SUMMARY

    - name: Upload Binary Artifact
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-linux-bin
        path: benchmark_bin
